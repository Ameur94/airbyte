version: "0.29.0"

definitions:
  selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path: ["{{ parameters.extractorPath }}"]
  requester:
    type: HttpRequester
    url_base: "https://api.persistiq.com/v1/"
    http_method: "GET"
    authenticator:
      type: NoAuth
    request_headers:
      x-api-key: "{{ config['api_key'] }}"

  retriever:
    type: SimpleRetriever
    record_selector:
      $ref: "#/definitions/selector"
    paginator:
      type: "DefaultPaginator"
      pagination_strategy:
        type: "CursorPagination"
        cursor_value: "{{ last_records['next_page'] }}"
      page_token_option:
        type: "RequestPath"
        field_name: "page"
        inject_into: "request_parameter"
    requester:
      $ref: "#/definitions/requester"

  base_stream:
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/retriever"

  users_stream:
    $ref: "#/definitions/base_stream"
    name: "users"
    primary_key: "id"
    $parameters:
      extractorPath: "users"
      path: "users"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          id:
            description: The unique identifier of the user.
            type:
              - string
          name:
            description: The name of the user.
            type:
              - "null"
              - string
          email:
            description: The email address of the user.
            type:
              - string
            format: email
          activated:
            description: Flag indicating if the user account is activated or not.
            type:
              - "null"
              - boolean
          default_mailbox_id:
            description: The default mailbox identifier associated with the user.
            type:
              - "null"
              - string
          salesforce_id:
            description: The Salesforce identifier associated with the user.
            type:
              - "null"
              - string
  leads_stream:
    $ref: "#/definitions/base_stream"
    name: "leads"
    primary_key: "id"
    $parameters:
      extractorPath: "leads"
      path: "leads"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type:
          - "null"
          - object
        additionalProperties: true
        properties:
          id:
            type:
              - string
          bounced:
            type:
              - "null"
              - boolean
          owner_id:
            type:
              - string
          creator_id:
            type:
              - "null"
              - string
          optedout:
            type:
              - "null"
              - boolean
          sent_count:
            type:
              - "null"
              - integer
          replied_count:
            type:
              - "null"
              - integer
          last_sent_at:
            type:
              - "null"
              - string
          status:
            type:
              - "null"
              - string
          data:
            company_name:
              type:
                - "null"
                - string
            email:
              type:
                - "null"
                - string
              format: email
            first_name:
              type:
                - "null"
                - string
            last_name:
              type:
                - "null"
                - string
            address:
              type:
                - "null"
                - string
            city:
              type:
                - "null"
                - string
            state:
              type:
                - "null"
                - string
            phone:
              type:
                - "null"
                - string
            title:
              type:
                - "null"
                - string
            industry:
              type:
                - "null"
                - string
            snippet:
              type:
                - "null"
                - string
            snippet1:
              type:
                - "null"
                - string
            snippet2:
              type:
                - "null"
                - string
            snippet3:
              type:
                - "null"
                - string
            snippet4:
              type:
                - "null"
                - string
            twitch_name:
              type:
                - "null"
                - string
            linkedin:
              type:
                - "null"
                - string
            twitter:
              type:
                - "null"
                - string
            facebook:
              type:
                - "null"
                - string
            salesforce_id:
              type:
                - "null"
                - string
  campaigns_stream:
    $ref: "#/definitions/base_stream"
    name: "campaigns"
    primary_key: "id"
    $parameters:
      extractorPath: "campaigns"
      path: "campaigns"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          id:
            description: Unique ID of the campaign
            type:
              - string
          name:
            description: Name of the campaign
            type:
              - "null"
              - string
          creator:
            description: Details of the campaign creator
            type:
              - "null"
              - object
            properties:
              id:
                description: Unique ID of the campaign creator
                type:
                  - "null"
                  - string
              name:
                description: Name of the campaign creator
                type:
                  - "null"
                  - string
              email:
                description: Email of the campaign creator
                type:
                  - "null"
                  - string
          stats:
            description: Statistics related to the campaign progress
            type:
              - "null"
              - object
            properties:
              prospects_contacted:
                description: Number of prospects contacted
                type:
                  - "null"
                  - integer
              prospects_reached:
                description: Number of prospects reached
                type:
                  - "null"
                  - integer
              prospects_opened:
                description: Number of prospects who opened the campaign
                type:
                  - "null"
                  - integer
              prospects_replied:
                description: Number of prospects who replied
                type:
                  - "null"
                  - integer
              prospects_bounced:
                description: Number of prospects bounced
                type:
                  - "null"
                  - integer
              prospects_optedout:
                description: Number of prospects who opted out
                type:
                  - "null"
                  - integer
              total_contacted:
                description: Total number of prospects contacted
                type:
                  - "null"
                  - integer
streams:
  - "#/definitions/users_stream"
  - "#/definitions/leads_stream"
  - "#/definitions/campaigns_stream"

check:
  type: CheckStream
  stream_names:
    - "users"
    - "leads"
    - "campaigns"

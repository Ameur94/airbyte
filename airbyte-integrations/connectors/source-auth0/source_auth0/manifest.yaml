version: "0.29.0"

definitions:
  selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path: []

  oauth_authenticator:
    type: OAuthAuthenticator
    token_refresh_endpoint: "{{ config['base_url'] }}oauth/token"
    client_id: "{{ config['credentials']['client_id'] }}"
    client_secret: "{{ config['credentials']['client_secret'] }}"
    refresh_token: ""

  bearer_authenticator:
    type: BearerAuthenticator
    api_token: "{{ config['credentials']['access_token'] }}"

  requester:
    type: HttpRequester
    url_base: "{{ config['base_url'] }}/api/v2"
    http_method: "GET"
    authenticator:
      class_name: source_auth0.components.AuthenticatorAuth0
      bearer: "#/definitions/bearer_authenticator"
      oauth: "#/definitions/oauth_authenticator"

  paginator:
    type: "DefaultPaginator"
    page_size_option:
      type: "RequestOption"
      inject_into: "request_parameter"
      field_name: "per_page"
    pagination_strategy:
      type: "PageIncrement"
      page_size: 50
    page_token_option:
      type: "RequestOption"
      inject_into: "request_parameter"
      field_name: "page"

  retriever:
    type: SimpleRetriever
    record_selector:
      $ref: "#/definitions/selector"
    paginator:
      $ref: "#/definitions/paginator"
    requester:
      $ref: "#/definitions/requester"

  base_stream:
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/retriever"

  clients_stream:
    $ref: "#/definitions/base_stream"
    name: "clients"
    primary_key: "client_id"
    $parameters:
      path: "clients"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type:
          - object
          - "null"
        additionalProperties: true
        properties:
          client_id:
            description: Unique identifier for the client.
            type:
              - string
              - "null"
          tenant:
            description: Tenant or domain associated with the client.
            type:
              - string
              - "null"
          owners:
            description: List of owners or administrators of the client.
            type:
              - "null"
              - array
            items:
              type:
                - string
                - "null"
          is_token_endpoint_ip_header_trusted:
            description: Whether the token endpoint IP header is trusted.
            type:
              - boolean
              - "null"
          cross_origin_auth:
            description: Whether cross-origin authentication is enabled for the client.
            type:
              - boolean
              - "null"
          callback_url_template:
            description: Template for callback URLs used by the client.
            type:
              - boolean
              - "null"
          name:
            description: Name or title of the client.
            type:
              - string
              - "null"
          description:
            description: Description or overview of the client.
            type:
              - string
              - "null"
          global:
            description: Whether the client settings are global.
            type:
              - boolean
              - "null"
          client_secret:
            description: Client secret used for authentication.
            type:
              - string
              - "null"
          app_type:
            description: Type of application (web, mobile, etc.) using this client.
            type:
              - string
              - "null"
          logo_uri:
            description: URI for the client's logo or branding image.
            type:
              - string
              - "null"
          is_first_party:
            description: Whether the client is considered a first-party application.
            type:
              - boolean
              - "null"
          oidc_conformant:
            description: Whether the client conforms to OIDC standards.
            type:
              - boolean
              - "null"
          callbacks:
            description: List of callback URLs registered for the client.
            type:
              - "null"
              - array
            items:
              type:
                - string
                - "null"
          allowed_origins:
            description:
              List of origins that are allowed to make requests to this
              client.
            type:
              - "null"
              - array
            items:
              type:
                - string
                - "null"
          web_origins:
            description: List of web origins allowed to authenticate with the client.
            type:
              - "null"
              - array
            items:
              type:
                - string
                - "null"
          client_aliases:
            description: Alternate names or aliases for the client.
            type:
              - "null"
              - array
            items:
              type:
                - string
                - "null"
          allowed_clients:
            description: List of clients that are allowed to access this client.
            type:
              - "null"
              - array
            items:
              type:
                - string
                - "null"
          allowed_logout_urls:
            description:
              List of URLs where the client can be redirected after logging
              out.
            type:
              - "null"
              - array
            items:
              type:
                - string
                - "null"
          oidc_backchannel_logout:
            description: Settings for OpenID Connect (OIDC) backchannel logout.
            type:
              - object
              - "null"
            additionalProperties: true
            properties:
              backchannel_logout_urls:
                description: URLs used for backchannel logout.
                type:
                  - "null"
                  - array
                items:
                  type:
                    - string
                    - "null"
          grant_types:
            description: Types of grants allowed for the client.
            type:
              - "null"
              - array
            items:
              type:
                - string
                - "null"
          jwt_configuration:
            description:
              Configuration settings for JSON Web Tokens (JWTs) used by
              the client.
            type:
              - object
              - "null"
            additionalProperties: true
            properties:
              lifetime_in_seconds:
                description: Lifetime duration of JWTs in seconds.
                type:
                  - integer
                  - "null"
              secret_encoded:
                description: Encoded secret used for JWT encryption.
                type:
                  - boolean
                  - "null"
              scopes:
                description: Scopes associated with the JWT.
                type:
                  - object
                  - "null"
              alg:
                description: Algorithm used for JWT signing and verification.
                type:
                  - string
                  - "null"
          signing_keys:
            description: Keys used for signing data associated with the client.
            type:
              - "null"
              - array
            items:
              type:
                - object
                - "null"
              additionalProperties: true
          encryption_key:
            description: Key used for encryption associated with the client.
            type:
              - object
              - "null"
            additionalProperties: true
            properties:
              pub:
                description: Public key for encryption.
                type:
                  - string
                  - "null"
              cert:
                description: Certificate used for encryption.
                type:
                  - string
                  - "null"
              subject:
                description: Subject or entity associated with the encryption key.
                type:
                  - string
                  - "null"
          sso:
            description: Single sign-on (SSO) configuration for the client.
            type:
              - boolean
              - "null"
          sso_disabled:
            description: Whether SSO is disabled for the client.
            type:
              - boolean
              - "null"
          cross_origin_authentication:
            description: Whether cross-origin authentication is supported.
            type:
              - boolean
              - "null"
          cross_origin_loc:
            description: Cross-origin locations allowed for the client.
            type:
              - string
              - "null"
          custom_login_page_on:
            description: Whether a custom login page is enabled for the client.
            type:
              - boolean
              - "null"
          custom_login_page:
            description: Custom login page associated with the client.
            type:
              - string
              - "null"
          custom_login_page_preview:
            description: Preview of the custom login page for the client.
            type:
              - string
              - "null"
          form_template:
            description: Template for forms or UI elements used by the client.
            type:
              - string
              - "null"
          addons:
            description: Additional features or functionalities added to the client.
            type:
              - object
              - "null"
            additionalProperties: true
          token_endpoint_auth_method:
            description: Authentication method used for token endpoint requests.
            type:
              - string
              - "null"
          client_metadata:
            description: Additional metadata associated with the client.
            type:
              - object
              - "null"
            additionalProperties: true
          mobile:
            description: Whether the client is a mobile application.
            type:
              - object
              - "null"
            additionalProperties: true
          initiate_login_uri:
            description: URI where logins are initiated for the client.
            type:
              - string
              - "null"
          native_social_login:
            description: Support for native social logins.
            type:
              - object
              - "null"
            additionalProperties: true
          refresh_token:
            description: Settings for refresh tokens associated with the client.
            type:
              - object
              - "null"
            properties:
              rotation_type:
                description: Type of rotation (e.g., rotating) for refresh tokens.
                type:
                  - string
                  - "null"
              expiration_type:
                description:
                  Type of expiration (e.g., absolute, sliding) for refresh
                  tokens.
                type:
                  - string
                  - "null"
              leeway:
                description: Leeway duration for refresh token expiration.
                type:
                  - integer
                  - "null"
          organization_usage:
            description: Usage permissions for organizations.
            type:
              - string
              - "null"
          organization_require_behavior:
            description: Required behavior for organization settings.
            type:
              - string
              - "null"
          client_authentication_methods:
            description: Authentication methods supported by the client.
            type:
              - object
              - "null"
            additionalProperties: true
  users_stream:
    type: DeclarativeStream
    $parameters:
      name: "users"
      primary_key: "user_id"
    retriever:
      type: SimpleRetriever
      record_selector:
        $ref: "#/definitions/selector"
      paginator:
        $ref: "#/definitions/paginator"
      requester:
        type: HttpRequester
        url_base: "{{ config['base_url'] }}/api/v2"
        path: "users"
        http_method: "GET"
        authenticator:
          class_name: source_auth0.components.AuthenticatorAuth0
          bearer: "#/definitions/bearer_authenticator"
          oauth: "#/definitions/oauth_authenticator"
        request_parameters:
          sort: "updated_at:1"
          include_totals: "false"
          q:
            "updated_at:{{ '{' }}{{stream_interval.start_time ~ '  TO ' ~ stream_interval.end_time
            ~ ']' if stream_interval.start_time else config['start_date'] ~ ' TO *]'}}"
        request_headers: {}
    incremental_sync:
      type: DatetimeBasedCursor
      cursor_field: "updated_at"
      datetime_format: "%Y-%m-%dT%H:%M:%S.%fZ"
      cursor_granularity: "PT0.001S"
      start_datetime:
        type: MinMaxDatetime
        datetime: "{{ config.get('start_date', '2013-01-01T00:00:00.000Z') }}"
        datetime_format: "%Y-%m-%dT%H:%M:%S.%fZ"
        min_datetime: "2013-01-01T00:00:00.000Z"
      end_datetime:
        type: MinMaxDatetime
        datetime: "{{ now_utc().strftime('%Y-%m-%dT%H:%M:%S.%fZ') }}"
      step: "P1Y"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type:
          - object
          - "null"
        additionalProperties: true
        properties:
          _links:
            description: Collection of hyperlinks related to the user
            type:
              - object
              - "null"
          user_id:
            description: Unique identifier of the user
            type:
              - string
              - "null"
          username:
            description: Username chosen by the user
            type:
              - string
              - "null"
          email:
            description: Email address of the user
            type:
              - string
              - "null"
          email_verified:
            description: Flag indicating if the user's email is verified
            type:
              - boolean
              - "null"
          phone_number:
            description: Phone number of the user
            type:
              - string
              - "null"
          phone_verified:
            description: Flag indicating if the user's phone number is verified
            type:
              - boolean
              - "null"
          created_at:
            description: Timestamp of when the user account was created
            format: date-time
            type:
              - string
              - "null"
          updated_at:
            description: Timestamp of when the user account was last updated
            format: date-time
            type:
              - string
              - "null"
          identities:
            description: Array of identities linked to the user
            type:
              - "null"
              - array
            items:
              type:
                - object
                - "null"
              additionalProperties: true
              properties:
                connection:
                  description: Identity provider connection
                  type:
                    - string
                    - "null"
          app_metadata:
            description: Custom metadata associated with the user
            type:
              - object
              - "null"
            additionalProperties: true
          user_metadata:
            description: Custom metadata associated with the user account
            type:
              - object
              - "null"
            additionalProperties: true
          picture:
            description: URL of the user's profile picture
            type:
              - string
              - "null"
          name:
            description: Full name of the user
            type:
              - string
              - "null"
          nickname:
            description: Nickname or username chosen by the user
            type:
              - string
              - "null"
          multifactor:
            description: Array of enabled multifactor authentication methods
            type:
              - "null"
              - array
            additionalProperties: true
            items:
              type:
                - string
                - "null"
          last_ip:
            description: IP address of the user's last login
            type:
              - string
              - "null"
          logins_count:
            description: Total count of user logins
            type:
              - integer
              - "null"
          blocked:
            description: Flag indicating if the user is blocked
            type:
              - boolean
              - "null"
          last_login:
            description: Timestamp of user's last login
            type:
              - string
              - "null"
          given_name:
            description: Given name of the user
            type:
              - string
              - "null"
          family_name:
            description: Family name of the user
            type:
              - string
              - "null"
  organizations_stream:
    $ref: "#/definitions/base_stream"
    name: "organizations"
    primary_key: "id"
    $parameters:
      path: "organizations"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type:
          - object
          - "null"
        additionalProperties: true
        properties:
          id:
            description: The unique identifier for the organization.
            type:
              - string
              - "null"
          name:
            description: The name of the organization.
            type:
              - string
              - "null"
          display_name:
            description: The display name of the organization.
            type:
              - string
              - "null"
          branding:
            description: Information about the branding of the organization.
            type:
              - object
              - "null"
            additionalProperties: true
          metadata:
            description: Additional metadata associated with the organization.
            type:
              - object
              - "null"
            additionalProperties: true
  organization_members_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/organizations_stream"
        parent_key: "id"
        partition_field: "parent_id"

  organization_members_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "organization_members"
      primary_key: "user_id"
      path: "organizations/{{ stream_partition.parent_id }}/members"
    retriever:
      $ref: "#/definitions/retriever"
      partition_router:
        $ref: "#/definitions/organization_members_partition_router"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type:
          - object
          - "null"
        additionalProperties: true
        properties:
          org_id:
            description:
              The unique identifier of the organization to which the member
              belongs.
            type:
              - string
              - "null"
          user_id:
            description: The unique identifier of the organization member.
            type:
              - string
              - "null"
          name:
            description: The name of the organization member.
            type:
              - string
              - "null"
          email:
            description: The email address of the organization member.
            type:
              - string
              - "null"
          picture:
            description: URL to the profile picture of the organization member.
            type:
              - string
              - "null"
  organization_member_roles_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/organization_members_stream"
        parent_key: "user_id"
        partition_field: "parent_user_id"

  organization_member_roles_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "organization_member_roles"
      primary_key: "id"
      path:
        "organizations/{{ stream_partition.parent_slice.parent_id }}/members/{{
        stream_partition.parent_user_id }}/roles"
    retriever:
      $ref: "#/definitions/retriever"
      partition_router:
        $ref: "#/definitions/organization_member_roles_partition_router"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type:
          - object
          - "null"
        additionalProperties: true
        properties:
          id:
            description: The unique identifier for the organization member role.
            type:
              - string
              - "null"
          org_id:
            description:
              The unique identifier of the organization the member role
              belongs to.
            type:
              - string
              - "null"
          user_id:
            description:
              The unique identifier of the user associated with the organization
              member role.
            type:
              - string
              - "null"
          name:
            description: The name of the organization member role.
            type:
              - string
              - "null"
          description:
            description:
              The detailed information describing the organization member
              role.
            type:
              - string
              - "null"
streams:
  - "#/definitions/clients_stream"
  - "#/definitions/users_stream"
  - "#/definitions/organizations_stream"
  - "#/definitions/organization_member_roles_stream"
  - "#/definitions/organization_members_stream"

check:
  type: CheckStream
  stream_names:
    - "clients"
    - "users"
    - "organizations"
    - "organization_member_roles"
    - "organization_members"

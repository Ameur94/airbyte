version: "0.29.0"

definitions:
  yotpo_extractor:
    type: DpathExtractor
    field_path: ["{{ parameters['extractorPath'] }}"]

  yotpo_stream_requester:
    type: HttpRequester
    url_base: "{{ parameters['requesterUrl'] }}"
    http_method: "GET"
    request_parameters:
      utoken: "{{ config['access_token'] }}"

  yotpo_paginator:
    type: "DefaultPaginator"
    page_size_option:
      type: "RequestOption"
      inject_into: "request_parameter"
      field_name: "count"
    pagination_strategy:
      type: "OffsetIncrement"
      page_size: 1
    page_token_option:
      type: "RequestOption"
      field_name: "page"
      inject_into: "request_parameter"

  yotpo_base:
    type: DeclarativeStream
    retriever:
      type: SimpleRetriever
      record_selector:
        type: RecordSelector
        extractor:
          $ref: "#/definitions/yotpo_extractor"
      paginator:
        $ref: "#/definitions/yotpo_paginator"
      requester:
        $ref: "#/definitions/yotpo_stream_requester"

  yotpo_base_without_pagination:
    type: DeclarativeStream
    retriever:
      type: SimpleRetriever
      record_selector:
        type: RecordSelector
        extractor:
          $ref: "#/definitions/yotpo_extractor"
      paginator:
        type: NoPagination
      requester:
        $ref: "#/definitions/yotpo_stream_requester"

  reviews_stream:
    $parameters:
      extractorPath: "reviews"
      path: "/apps/{{ config['app_key'] }}/reviews"
      requesterUrl: "https://api.yotpo.com/v1"
    $ref: "#/definitions/yotpo_base"
    incremental_sync:
      type: DatetimeBasedCursor
      cursor_field: "created_at"
      datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
      cursor_granularity: "PT0.000001S"
      lookback_window: "P31D"
      start_datetime:
        datetime: "{{ config['start_date'] }}"
        datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
      end_datetime:
        datetime: "{{ today_utc() }}"
        datetime_format: "%Y-%m-%d"
      step: "P1M"
    name: "reviews"
    primary_key: "id"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: Reviews Schema
        additionalProperties: true
        type: object
        properties:
          id:
            description: Unique identifier for the review
            type:
              - "null"
              - number
          title:
            description: Title of the review
            type:
              - "null"
              - string
          incentive_type:
            description: Type of incentive given for the review
            type:
              - "null"
              - string
          content:
            description: The text content of the review
            type:
              - "null"
              - string
          score:
            description: The numerical score given by the reviewer
            type:
              - "null"
              - number
          votes_up:
            description: Number of upvotes for the review
            type:
              - "null"
              - number
          votes_down:
            description: Number of downvotes for the review
            type:
              - "null"
              - number
          created_at:
            description: The date and time when the review was created
            type:
              - "null"
              - string
            format: date-time
          updated_at:
            description: The date and time when the review was last updated
            type:
              - "null"
              - string
            format: date-time
          sentiment:
            description: Sentiment of the review (positive, negative, neutral)
            type:
              - "null"
              - number
          sku:
            description: Stock Keeping Unit of the product being reviewed
            type:
              - "null"
              - string
          name:
            description: Name of the reviewer
            type:
              - "null"
              - string
          email:
            description: Email of the reviewer
            type:
              - "null"
              - string
          reviewer_type:
            description: Type of the reviewer (e.g., verified buyer)
            type:
              - "null"
              - string
          deleted:
            description: Indicates if the review has been deleted
            type:
              - "null"
              - boolean
          archived:
            description: Indicates if the review has been archived
            type:
              - "null"
              - boolean
          escalated:
            description: Indicates if the review has been escalated for further action
            type:
              - "null"
              - boolean
          is_incentivized:
            description: Indicates if the review is incentivized
            type:
              - "null"
              - boolean
  email_analytics_stream:
    $parameters:
      extractorPath: "date_series_points"
      path: "/emails/{{ config['app_key'] }}/emails_sent"
      requesterUrl: "https://api.yotpo.com/analytics/v1"
    $ref: "#/definitions/yotpo_base_without_pagination"
    name: "email_analytics"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: Email Analytics
        additionalProperties: true
        type: object
        properties:
          since:
            description: The start date for the email analytics data.
            type:
              - "null"
              - string
          until:
            description: The end date for the email analytics data.
            type:
              - "null"
              - string
          values:
            description: An object containing the values related to email analytics.
            type:
              - "null"
              - object
            properties:
              done:
                description: Represents the status of email analytics data calculation.
                type:
                  - "null"
                  - boolean
  raw_data_stream:
    $parameters:
      extractorPath: "records"
      path: "/emails/{{ config['app_key'] }}/export/raw_data"
      requesterUrl: "https://api.yotpo.com/analytics/v1"
    $ref: "#/definitions/yotpo_base_without_pagination"
    name: "raw_data"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: Raw Data Schema
        additionalProperties: true
        type: object
        properties:
          email_address:
            description: Recipient's email address
            type:
              - "null"
              - string
          order_id:
            description: Unique identifier for the order related to the email
            type:
              - "null"
              - string
          order_timestamp:
            description: Timestamp when the order was placed
            type:
              - "null"
              - string
          product_id:
            description: Identifier for the product being reviewed or mentioned
            type:
              - "null"
              - string
          sku:
            description: Stock Keeping Unit (SKU) associated with the product
            type:
              - "null"
              - number
          email_type:
            description: Type or category of the email (e.g., promotional, transactional)
            type:
              - "null"
              - string
          reminder_num:
            description: Number indicating the reminder email sequence
            type:
              - "null"
              - number
          trr_bundle_id:
            description: Unique identifier for the bundle in a 'Try&Review' campaign
            type:
              - "null"
              - string
          trr_bundle_subject:
            description: Subject or title of the 'Try&Review' bundle
            type:
              - "null"
              - string
          review_type:
            description: Type of review (e.g., product review, service review)
            type:
              - "null"
              - string
          coupon_code:
            description: The coupon code associated with the email campaign
            type:
              - "null"
              - number
          email_sent_timestamp:
            description: Timestamp when the email was sent to the recipient
            type:
              - "null"
              - string
          opened_timestamp:
            description: Timestamp when the email was opened by the recipient
            type:
              - "null"
              - string
          clicked_through_timestamp:
            description: Timestamp when the recipient clicked through the email content
            type:
              - "null"
              - string
          content_creation_timestamp:
            description: Timestamp when the content for review creation was generated
            type:
              - "null"
              - string
          platform:
            description: The platform or channel from which the action originated
            type:
              - "null"
              - string
          invalid_address_timestamp:
            description: Timestamp when the email address was marked as invalid
            type:
              - "null"
              - string
          failed_timestamp:
            description: Timestamp when the email delivery failed
            type:
              - "null"
              - string
          unsubscribed_timestamp:
            description: Timestamp when the recipient unsubscribed from future emails
            type:
              - "null"
              - string
          marked_spam_timestamp:
            description: Timestamp when the email was marked as spam by the recipient
            type:
              - "null"
              - string
          arrived_early_timestamp:
            description:
              Timestamp when the email arrived early to the recipient's
              inbox
            type:
              - "null"
              - string
  unsubscribers_stream:
    $parameters:
      extractorPath: |
        "response", "unsubscribers"
      requesterUrl: "https://api.yotpo.com"
      path: "/apps/{{ config['app_key'] }}/unsubscribers"
    $ref: "#/definitions/yotpo_base"
    name: "unsubscribers"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: Unsubscribers Schema
        additionalProperties: true
        type: object
        properties:
          id:
            description: The unique identifier for the unsubscribed record.
            type:
              - "null"
              - number
          user_email:
            description:
              The email address of the user who unsubscribed from the specified
              email type.
            type:
              - "null"
              - string
          email_type_id:
            description:
              The identifier for the type of email where the unsubscribe
              action occurred.
            type:
              - "null"
              - number
          unsubscribed_by_name:
            description: The name of the user who initiated the unsubscribe action.
            type:
              - "null"
              - string
  webhook_events_stream:
    $parameters:
      extractorPath: |
        "response", "webhook_events"
      requesterUrl: "https://api.yotpo.com"
      path: "/webhook_events"
    $ref: "#/definitions/yotpo_base_without_pagination"
    name: "webhook_events"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: Webhook events Schema
        additionalProperties: true
        type: object
        properties:
          name:
            description: Name of the webhook event.
            type:
              - "null"
              - string
          description:
            description: Description of the webhook event data.
            type:
              - "null"
              - string
  webhooks_stream:
    $parameters:
      extractorPath: |
        "response", "webhooks"
      requesterUrl: "https://api.yotpo.com"
      path: "/apps/{{ config['app_key'] }}/webhooks"
    $ref: "#/definitions/yotpo_base_without_pagination"
    name: "webhooks"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: Webhooks Schema
        additionalProperties: true
        type:
          - "null"
          - object
        properties:
          id:
            description: The unique identifier for the webhook data.
            type:
              - "null"
              - number
          webhook_event_id:
            description: The identifier for the specific webhook event.
            type:
              - "null"
              - number
          webhook_event_name:
            description: The name of the webhook event triggered.
            type:
              - "null"
              - string
          url:
            description: The endpoint URL where the webhook data is sent.
            type:
              - "null"
              - string
          version:
            description: The version of the webhook data structure.
            type:
              - "null"
              - number
streams:
  - "#/definitions/email_analytics_stream"
  - "#/definitions/raw_data_stream"
  - "#/definitions/reviews_stream"
  - "#/definitions/webhooks_stream"
  - "#/definitions/unsubscribers_stream"
  - "#/definitions/webhook_events_stream"

check:
  type: CheckStream
  stream_names:
    - "email_analytics"
    - "raw_data"
    - "reviews"
    - "unsubscribers"
    - "webhooks"
    - "webhook_events"
